---
title: 5种Mybatis的批量插入方式的比较
categories:
- 学习记录
tags:
- mybatis
---

## 写在前面

​	在开发中我们经常需要进行批量插入，而Mybatis提供了多种方法进行批量插入，本文主要分析这5种方法的异同。以下表格按照10000条数据的插入时间从小到大排列。

| 序号 | 方法                                        | 描述                                                         | 10000条数据的插入时间(仅供参考视具体环境而定) |
| ---- | ------------------------------------------- | ------------------------------------------------------------ | --------------------------------------------- |
| 1    | MyBatis以集合方式批量新增                   | 将集合作为参数传递给SQL语句，然后使用foreach标签进行批量插入 | 389ms                                         |
| 2    | MyBatis-Plus提供的InsertBatchSomeColumn方法 | 调用mp提供的InsertBatchSomeColumn方法                        | 409ms                                         |
| 3    | MyBatis的手动批量提交                       | 关闭自动提交，然后手动提交通过手动批量提交，可以提高插入性能，减少数据库的I/O操作                                   | 2267ms                                        |
| 4    | MyBatis-Plus提供的SaveBatch方法             | 调用mp提供的SaveBatch方法                                    | 2486ms                                        |
| 5    | MyBatis利用For循环批量插入                  | 使用for循环生成多条insert语句                                | 3562ms                                        |

<!-- more -->

## 0 测试准备工作

> 新建一个springboot项目方便进行测试(每次测试后都会truncate)

### 0.1 数据库准备
​    在这里用一个user表进行测试创建语句：

```sql
CREATE TABLE user (
user_name varchar(100) DEFAULT NULL,
password varchar(100) DEFAULT NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```



### 0.2 实体类准备

```java
public class UserDO {
    private String userName;
    private String password;

    public String getUserName() {
        return userName;
    }

    public void setUserName(String userName) {
        this.userName = userName;
    }

    public String getPassword() {
        return password;
    }

    public void setPassword(String password) {
        this.password = password;
    }
}
```

### 0.3 pom文件

```xml
		<!--Mybatis依赖-->
		<dependency>
			<groupId>org.mybatis.spring.boot</groupId>
			<artifactId>mybatis-spring-boot-starter</artifactId>
			<version>2.2.2</version>
		</dependency>
		<!--Mybatis-Plus依赖-->
		<dependency>
			<groupId>com.baomidou</groupId>
			<artifactId>mybatis-plus-boot-starter</artifactId>
			<version>3.5.2</version>
		</dependency>
		<dependency>
			<groupId>mysql</groupId>
			<artifactId>mysql-connector-java</artifactId>
			<version>8.0.29</version>
		</dependency>
```

## 1.MyBatis利用For循环批量插入

​	最粗暴的一种方式，使用方式如下：

​	1.创建一个UserService编写逻辑

```java
@Service
public class UserService {
 @Resource
    private UserMapper userMapper;
     /**
     * 1.MyBatis利用For循环批量插入
     */
    public void InsertUsers(){
        long start = System.currentTimeMillis();
        for(int i = 0 ;i < 10000; i++) {
            UserDO user = new UserDO();
            user.setUserName("name" + i);
            user.setPassword("password" + i);
            userMapper.insertUsers(user);
        }
        long end = System.currentTimeMillis();
        System.out.println("一万条数据总耗时：" + (end-start) + "ms" );
    }
}
```

​	2.编写UserMapper

```java
@Mapper
public interface  UserMapper {
 	Integer insertUsers(UserDO user);
}
```

​	3.编写mapper.xml文件

```xml
  <insert id="insertUsers">
        INSERT INTO user (user_name, password)
        VALUES(#{userName}, #{password})
    </insert>
```

​	4.编写测试类

```java
@SpringBootTest
class SpringbootAppApplicationTests {
	@Resource
		UserService userService;
	@Test
	void BatchInsertTest(){
	//		1.MyBatis利用For循环批量插入
		userService.InsertUsers();
	}
}
```

​	5.测试结果

![Snipaste_2024-06-07_11-09-27](https://cdn.jsdelivr.net/gh/lbwdada/Mybolg_img/2024-06-07/5%E7%A7%8DMybatis%E7%9A%84%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%96%B9%E5%BC%8F%E7%9A%84%E6%AF%94%E8%BE%83/0.png)

## 2 MyBatis的手动批量提交

​	1.在UserService中添加一个新的方法

```java
   
	@Resource
    	private SqlSessionTemplate sqlSessionTemplate;
	/**
     * 2：MyBatis的手动批量提交
     */
    public void InsertUsers2(){
        //关闭自动提交
        SqlSession sqlSession = sqlSessionTemplate.getSqlSessionFactory().openSession(ExecutorType.BATCH, false);
        UserMapper userMapper = sqlSession.getMapper(UserMapper.class);
        long start = System.currentTimeMillis();
        for(int i = 0 ;i < 10000; i++) {
            UserDO user = new UserDO();
            user.setUserName("name" + i);
            user.setPassword("password" + i);
            userMapper.insertUsers(user);
        }
        sqlSession.commit();
        long end = System.currentTimeMillis();
        System.out.println("一万条数据总耗时：" + (end-start) + "ms" );
    }
```

​	2.在测试类中调用

​	3.测试结果

![Snipaste_2024-06-07_11-13-22](https://cdn.jsdelivr.net/gh/lbwdada/Mybolg_img/2024-06-07/5%E7%A7%8DMybatis%E7%9A%84%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%96%B9%E5%BC%8F%E7%9A%84%E6%AF%94%E8%BE%83/1.png)

## 3 MyBatis以集合方式批量新增

​	1.在UserService中新增一个方法

```java
 /**
     * 3：MyBatis以集合方式批量新增
     */
    public void InsertUsers3(){
        long start = System.currentTimeMillis();
        List<UserDO> userList = new ArrayList<>();
        UserDO user;
        for(int i = 0 ;i < 10000; i++) {
            user = new UserDO();
            user.setUserName("name" + i);
            user.setPassword("password" + i);
            userList.add(user);
        }
        userMapper.insertUsersBatch(userList);
        long end = System.currentTimeMillis();
        System.out.println("一万条数据总耗时：" + (end-start) + "ms" );
    }
```

​	2.在UserMapper中新增一个方法

```Java
Integer  insertUsersBatch(List<UserDO> userList);
```

​	3.在mapper.xml中添加新的映射方法

```xml
 <insert id="insertUsersBatch">
        INSERT INTO user (user_name, password)
        VALUES
        <foreach collection ="userList" item="user" separator =",">
            (#{user.userName}, #{user.password})
        </foreach>
    </insert>
```

​	3.在测试类中调用

​	4.测试结果

![Snipaste_2024-06-07_11-15-55](https://cdn.jsdelivr.net/gh/lbwdada/Mybolg_img/2024-06-07/5%E7%A7%8DMybatis%E7%9A%84%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%96%B9%E5%BC%8F%E7%9A%84%E6%AF%94%E8%BE%83/2.png)

## 4 MyBatis-Plus提供的SaveBatch方法

​	1.因为这里使用的是mp提供的方法所以我新建了一个UserPlusService用来区分

```Java
@Service
public class UserPlusService extends ServiceImpl<UserPlusMapper, UserDO> implements IService<UserDO> {
	  /**
     * 4：MyBatis-Plus提供的SaveBatch方法
     */
    public void InsertUsers4() {
        long start = System.currentTimeMillis();
        List<UserDO> userList = new ArrayList<>();
        UserDO user;
        for(int i = 0 ;i < 10000; i++) {
            user = new UserDO();
            user.setUserName("name" + i);
            user.setPassword("password" + i);
            userList.add(user);
        }
        saveBatch(userList);
        long end = System.currentTimeMillis();
        System.out.println("一万条数据总耗时：" + (end-start) + "ms" );
    }
}
```

​	2.在测试类中引用此类并测试

​	3.测试结果

![Snipaste_2024-06-07_11-22-56](https://cdn.jsdelivr.net/gh/lbwdada/Mybolg_img/2024-06-07/5%E7%A7%8DMybatis%E7%9A%84%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%96%B9%E5%BC%8F%E7%9A%84%E6%AF%94%E8%BE%83/3.png)

## 5 MyBatis-Plus提供的InsertBatchSomeColumn方法

​	1.编写EasySqlInjector自定义类

```java
public class EasySqlInjector extends DefaultSqlInjector {
    @Override
    public List<AbstractMethod> getMethodList(Class<?> mapperClass, TableInfo tableInfo) {
        // 注意：此SQL注入器继承了DefaultSqlInjector(默认注入器)，调用了DefaultSqlInjector的getMethodList方法，保留了mybatis-plus的自带方法
        List<AbstractMethod> methodList = super.getMethodList(mapperClass, tableInfo);
        methodList.add(new InsertBatchSomeColumn(i -> i.getFieldFill() != FieldFill.UPDATE));
        return methodList;
    }
}
```

​	2.定义核心配置类注入此Bean

```java
@Configuration
public class MybatisPlusConfig {
    @Bean
    public EasySqlInjector sqlInjector() {
        return new EasySqlInjector();
    }
}
```

​	3.在UserPlusService中添加新的方法

```java
  
	@Resource
    EasyUserMapper easyUserMapper;
	/**
     * 5：MyBatis-Plus提供的InsertBatchSomeColumn方法
     */

    public void InsertUsers5(){
        long start = System.currentTimeMillis();
        List<UserDO> userList = new ArrayList<>();
        UserDO user;
        for(int i = 0 ;i < 10000; i++) {
            user = new UserDO();
            user.setUserName("name" + i);
            user.setPassword("password" + i);
            userList.add(user);
        }
        easyUserMapper.insertBatchSomeColumn(userList);
        long end = System.currentTimeMillis();
        System.out.println("一万条数据总耗时：" + (end-start) + "ms" );
    }
```

​	4.编写EasyBaseMapper接口

```java
public interface EasyBaseMapper<T> extends BaseMapper<T> {

    /**
     * 批量插入 仅适用于mysql
     *
     * @param entityList 实体列表
     * @return 影响行数
     */
    Integer insertBatchSomeColumn(Collection<T> entityList);

}
```

​	5.编写EasyUserMapper接口

```java
@Mapper
public interface EasyUserMapper extends EasyBaseMapper<UserDO> {
}
```

​	6.测试结果

![](https://cdn.jsdelivr.net/gh/lbwdada/Mybolg_img/2024-06-07/5%E7%A7%8DMybatis%E7%9A%84%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5%E6%96%B9%E5%BC%8F%E7%9A%84%E6%AF%94%E8%BE%83/4.png)

## 总结

​	通过上面的测试可以看出第五种使用InsertBatchSomeColumn方法和第三种MyBatis以集合方式批量新增的方式是最快的，而mp的SaveBatch方法因为也是通过循环拼接一条一条的sql然后进行批量提交故导致时间和第二种方式差不多。**以上，在数据量较大时要进行批量插入最好使用insert into table_name(xx,xx) values(aa,bb),(cc,dd)......这种格式的sql进行插入，但要注意数据库服务支持的网络数据传输最大值可根据情况对大数据量列表进行拆分再插入。**
